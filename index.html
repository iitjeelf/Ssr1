<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam</title>

<style>
body{font-family:"SF Pro Display",Arial,sans-serif;margin:0;background:#fff;color:#000;}
header{background:linear-gradient(145deg,#E6E6FA,#D8BFD8);color:#4B0082;text-align:center;padding:20px;font-size:36px;font-weight:700;letter-spacing:1.5px;box-shadow:0 5px #aaa;text-shadow:0 1px 2px #fff;}
#studentEntry,#examArea{padding:16px;text-align:center;}

/* CENTER FIRST PAGE (Name, Section, Roll, Admission, Start Exam) */
#studentEntry{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  min-height:calc(100vh - 140px);
}

.form-group{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-bottom:60px;}
.form-group label{font-size:1.15rem;font-weight:600;margin-right:10px;color:#4B0082;width:120px;text-align:right;}
input[type="text"]{padding:10px 12px;font-size:1.1rem;border-radius:10px;border:1.5px solid #4B0082;outline:none;min-width:250px;}
input.error{animation:glowRed 0.5s alternate infinite;border-color:red;}
@keyframes glowRed{0%{box-shadow:0 0 5px red;}100%{box-shadow:0 0 15px red;}}
button{position:relative;overflow:hidden;cursor:pointer;border:none;border-radius:12px;transition:all .18s ease;box-shadow:0 6px #aaa;background:linear-gradient(to bottom,#fafaff,#dcd6f7);color:#4B0082;font-weight:600;padding:10px 20px;font-size:18px;}
button:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(0,0,0,.28);}
button:active{transform:translateY(3px) scale(.98);}
.optBtn{font-size:16px;padding:8px 18px;margin:6px;border:2px solid #4B0082;background:#fff;border-radius:8px;box-shadow:0 5px #aaa;}
.optBtn.selected{background:#32CD32;color:#fff;border-color:#2fa92f;}
.navContainer{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap}
.navBtn{font-size:16px;padding:10px 20px;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;background:linear-gradient(145deg,#1E90FF,#4682B4);}
#markReviewBtn{background:linear-gradient(145deg,#ffb84d,#ff9900)}
#submitBtn{background:linear-gradient(145deg,#c8b88a,#b49e60)}
#timerEl{font-size:20px;font-weight:bold;color:#4B0082;padding:6px 12px;border-radius:6px;background:#f0f0ff;display:inline-block;transition: all 0.3s ease;}
#timerEl.blink{animation:blinkTimer 1s infinite;}
@keyframes blinkTimer{0%{background:#ff6666;color:#fff;}50%{background:#fff;color:#4B0082;}100%{background:#ff6666;color:#fff;}}
#paletteContainer button{width:36px;height:36px;border-radius:50%;font-size:14px;margin:3px;border:1px solid #4B0082;background:#E6E6FA;color:#4B0082;}
#paletteContainer button.selected{background:#32CD32;color:#fff;border-color:#2fa92f}
#paletteContainer button.reviewed{background:yellow;color:#000}
#paletteContainer button.current{border:3px solid red}
footer{background:#E6E6FA;color:#4B0082;padding:10px;text-align:center;font-weight:bold;position:fixed;width:100%;bottom:0;}
.sectionTitle{font-size:22px;color:#4B0082;font-weight:bold;margin-bottom:8px;}
img.questionImg{max-width:100%;border-radius:10px;}
.glow {animation: glowPulse 1.6s infinite alternate;box-shadow:0 8px 18px rgba(75,0,130,0.12);}
@keyframes glowPulse{0% { box-shadow:0 6px 10px rgba(75,0,130,0.06); transform:translateY(0); } 50% { box-shadow:0 12px 30px rgba(75,0,130,0.14); transform:translateY(-2px); } 100% { box-shadow:0 6px 10px rgba(75,0,130,0.06); transform:translateY(0); }}

#fullRedOverlay{ position:fixed; left:0; top:0; width:100%; height:100%; display:none; background:red; z-index:9999; pointer-events:auto; }
#accessDeniedBox{ position:fixed; left:50%; top:40%; transform:translate(-50%,-50%); z-index:10000; color:#fff; text-align:center; display:none; pointer-events:auto; }
#accessDeniedBox h1{ font-size:48px; font-weight:900; margin:0 0 18px 0; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,0.4); }
#callAdminBtn{ padding:12px 22px; border-radius:12px; font-weight:800; }

.confirmModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:10001;}
.confirmBox{background:#fff;padding:20px;border-radius:12px;min-width:280px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.confirmBox p{font-size:18px;color:#4B0082;margin-bottom:15px;}
.confirmBox button{margin:0 10px;padding:8px 16px;font-size:16px;cursor:pointer;}

@media(max-width:600px){
  #accessDeniedBox h1{font-size:28px;}
  #callAdminBtn{padding:10px 14px;}
  .form-group{flex-direction:column;align-items:flex-start;}
  .form-group label{text-align:left;width:auto;margin-bottom:5px;}
}

#stuInfo { text-align: left !important; white-space:nowrap; }

#adminPassModal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 20000;
}
#adminPassBox {
  background: #fff;
  padding: 20px;
  text-align: center;
  width: 260px;
  border-radius: 12px;
}
#adminPassBox input {
  width: 90%;
  padding: 10px;
  border: 1px solid #4B0082;
  border-radius: 8px;
}

/* FULL LINE BLINK LAST 1 MIN */
.blinkLine {
    animation: blinkLineAnim 1s infinite;
}
@keyframes blinkLineAnim {
    0% { background: #ffcccc; }
    50% { background: #ffffff; }
    100% { background: #ffcccc; }
}

/* 20% BIGGER HEADER TEXT */
#stuInfo, #stuQInfo, #timerEl {
    font-size: 20px !important;
}
/* Increase table row height vertically */
table td, table th {
    padding-top: 20px;
    padding-bottom: 20px;
}

</style>
</head>

<body>

<header>LFJC ONLINE EXAMINATION</header>

<div id="studentEntry">
  <div class="form-group"><label>NAME</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off"></div>
  <div class="form-group"><label>SECTION</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
  <div class="form-group"><label>ROLL NUMBER</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><label>ADMISSION NUMBER</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
  <p id="studentMsg"></p>
  <p id="keyStatus" style="color:#4B0082;font-weight:600;"></p>
</div>

<div id="examArea" style="display:none;">

  <!-- HEADER FIXED -->
  <div id="examHeader" style="display:flex;align-items:center;width:100%;font-weight:bold;">
    <div id="stuInfo" style="flex:0 0 auto;text-align:left; white-space:nowrap;"></div>
    <div id="stuQInfo" style="flex:1;text-align:center; white-space:nowrap;"></div>
    <div style="flex:0 0 auto;text-align:right; white-space:nowrap;">
        <span id="timerEl">ðŸ•’ 00:00</span>
    </div>
  </div>

  <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">â¬… Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button>
    <button class="navBtn" id="nextBtn">Next âž¡</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>

  <div id="paletteContainer"></div>
</div>

<footer>LFJC@2025 All rights reserved</footer>

<div id="fullRedOverlay"></div>
<div id="accessDeniedBox">
  <h1>ACCESS DENIED</h1>
  <button id="callAdminBtn" class="glow">Enter Password</button>
</div>

<div class="confirmModal" id="confirmModal">
  <div class="confirmBox">
    <p id="confirmText">Confirm?</p>
    <button id="confirmYes">Yes</button>
    <button id="confirmNo">No</button>
  </div>
</div>

<div id="adminPassModal">
  <div id="adminPassBox">
    <h3>Enter Admin Password</h3>
    <input type="password" id="adminPassInput">
    <br><br>
    <button id="adminPassSubmit">Submit</button>
  </div>
</div>

<script>
const MARK_PER_CORRECT=1,MARK_PER_WRONG=-0.25;

// DYNAMIC: images and answerKey will be populated from Answers/Key
let images = [];
let answerKey = [];
let keyLoaded = false;

const subjects=["Maths","Physics","Chemistry"];
/* GOOGLE SHEET FUNCTION */
function sendToGoogleSheet(subject, correct, wrong, blank, total, percentage) {
    const url = "https://script.google.com/macros/s/AKfycbzlLZkaZ5U7nRskKrRasLUsRJYmSmCE11F90bMR0Xl-B20TFGfoMvI8eZGe9ov44mTh/exec";

    const payload = {
        name: progress.student.name,
        section: progress.student.sec,
        roll: progress.student.roll,
        adm: progress.student.adm,
        subject: subject,
        correct: correct,
        wrong: wrong,
        blank: blank,
        total: total,
        percentage: percentage
    };

    fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).catch(e=>console.error('Google Sheet upload failed',e));
}

let examData={files:[],subjectNames:[],keys:[]};
let progress=null,timerInterval=null;

// Fetch the answer key file from Answers/Key on page load
fetch('Answers/Key')
  .then(res=>{
    if(!res.ok) throw new Error('Key file not found or not accessible');
    return res.text();
  })
  .then(text=>{
    // Expecting 5 answers per line, no commas
    answerKey = text.trim().split('\n').map(line => line.trim().split('')).flat();
    // Build image paths automatically based on key length
    for(let i=1;i<=answerKey.length;i++){
      images.push(`questions/${i}.png`);
    }
    keyLoaded = true;
    document.getElementById('keyStatus').textContent = 'Answer key loaded ('+answerKey.length+' items).';
    validateStudentInputs(); // revalidate to show start button if inputs OK
    console.log('Loaded answer key:', answerKey);
  })
  .catch(err=>{
    console.error('Failed to load Answers/Key:', err);
    document.getElementById('keyStatus').textContent = 'Error: could not load Answers/Key â€” exam disabled.';
    document.getElementById('keyStatus').style.color = 'red';
  });

function shuffleArray(arr){const c=arr.slice();for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[c[i],c[j]]=[c[j],c[i]];}return c;}

function prepareExamData(){
  examData.files=[];examData.subjectNames=[];examData.keys=[];
  const total=images.length,base=Math.floor(total/3);
  let remainder=total%3,start=0,groups=[];
  for(let s=0;s<3;s++){
    const count=base+(remainder>0?1:0); remainder--;
    const imgs=images.slice(start,start+count);
    const keys=answerKey.slice(start,start+count); start+=count;
    const idxs=shuffleArray([...Array(imgs.length).keys()]);
    groups.push({name:subjects[s],imgs:idxs.map(i=>imgs[i]),keys:idxs.map(i=>keys[i])});
  }
  shuffleArray(groups).forEach(g=>g.imgs.forEach((img,i)=>{examData.files.push(img);examData.keys.push(g.keys[i]);examData.subjectNames.push(g.name);}));
}

function validateStudentInputs(){
  const n=stuName,s=stuSection,r=stuRoll,a=stuAdm;
  let v1=/^[A-Za-z .]+$/.test(n.value),v2=/^[A-Za-z0-9]+$/.test(s.value),
      v3=/^[0-9]+$/.test(r.value),v4=/^[0-9]+$/.test(a.value);
  n.classList.toggle('error',!v1&&n.value!==""); s.classList.toggle('error',!v2&&s.value!=="");
  r.classList.toggle('error',!v3&&r.value!==""); a.classList.toggle('error',!v4&&a.value!=="");
  // Only show start when inputs valid AND key loaded
  stuStartBtn.style.display=(v1&&v2&&v3&&v4 && keyLoaded)?"inline-block":"none";
  return v1&&v2&&v3&&v4 && keyLoaded;
}
["stuName","stuSection","stuRoll","stuAdm"].forEach(id=>document.getElementById(id).addEventListener("input",validateStudentInputs));

function showConfirm(msg,cb){
  confirmText.textContent=msg;
  confirmModal.style.display="flex";
  confirmYes.onclick=()=>{confirmModal.style.display="none";cb(true);};
  confirmNo.onclick=()=>{confirmModal.style.display="none";cb(false);};
}

stuStartBtn.onclick=()=>{ if(!validateStudentInputs())return; showConfirm("Start Exam?", startWithSecurity); };

function startWithSecurity(ok){
  if(!ok)return;
  const studentKey=`${stuName.value}|${stuSection.value}|${stuRoll.value}|${stuAdm.value}`;
  const stored=localStorage.getItem(studentKey),now=Date.now();
  if(stored && now-stored<86400000){
    fullRedOverlay.style.display="block"; accessDeniedBox.style.display="block";
    callAdminBtn.onclick=()=>{
      adminPassModal.style.display="flex";
      adminPassSubmit.onclick=()=>{
        if(adminPassInput.value==="lfjc2025"){
          adminPassModal.style.display="none";
          fullRedOverlay.style.display="none"; accessDeniedBox.style.display="none";
          startExam(studentKey);
        }else alert("Incorrect password!");
      };
    };
  } else startExam(studentKey);
}

function startExam(studentKey){
  // ensure key is loaded
  if(!keyLoaded){
    alert('Answer key not loaded. Contact admin.');
    return;
  }

  localStorage.setItem(studentKey,Date.now());
  prepareExamData();
  progress={answers:Array(examData.files.length).fill(null),review:Array(examData.files.length).fill(false),
  currentIndex:0,student:{name:stuName.value,sec:stuSection.value,roll:stuRoll.value,adm:stuAdm.value},timeLeftSec:5*60};

  studentEntry.style.display="none";
  examArea.style.display="block";
  renderQuestion(); renderPalette(); startTimer(); updateNavButtons();
}

function startTimer(){
  timerInterval=setInterval(()=>{
    if(progress.timeLeftSec<=0){clearInterval(timerInterval);submitExam();return;}
    progress.timeLeftSec--;
    let m=Math.floor(progress.timeLeftSec/60), s=progress.timeLeftSec%60;
    timerEl.textContent=`ðŸ•’ ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    stuInfo.textContent=`${progress.student.name} | ${progress.student.sec} | ${progress.student.roll} | ${progress.student.adm}`;
    stuQInfo.textContent = `${examData.subjectNames[progress.currentIndex]} | Q ${progress.currentIndex+1}/${examData.files.length}`;

    if(progress.timeLeftSec <= 300 && progress.timeLeftSec > 60){
        timerEl.classList.add("blink");
    } else { timerEl.classList.remove("blink"); }

    if(progress.timeLeftSec <= 60){
        timerEl.classList.add("blink");
        examHeader.classList.add("blinkLine");
    } else {
        examHeader.classList.remove("blinkLine");
    }
  },1000);
}

function renderQuestion(){
  const i=progress.currentIndex,f=examData.files[i];
  questionContainer.innerHTML=`<img src="${f}" class="questionImg"><br>`;
  const optsDiv = document.createElement("div");
  optsDiv.style.marginTop="50px";
  ["A","B","C","D"].forEach(opt=>{
    let b=document.createElement("button"); 
    b.className="optBtn"; 
    b.style.margin = "0 40px";   // DOUBLE GAP ADDED
    b.textContent=opt;
    if(progress.answers[i]===opt)b.classList.add("selected");
    b.onclick=()=>{progress.answers[i]=(progress.answers[i]===opt?null:opt); renderPalette(); renderQuestion();};
    optsDiv.appendChild(b);
  });
  questionContainer.appendChild(optsDiv);
}

prevBtn.onclick=()=>{if(progress.currentIndex>0){progress.currentIndex--;renderQuestion();renderPalette();updateNavButtons();}};
nextBtn.onclick=()=>{if(progress.currentIndex<examData.files.length-1){progress.currentIndex++;renderQuestion();renderPalette();updateNavButtons();}};
markReviewBtn.onclick=()=>{progress.review[progress.currentIndex]=!progress.review[progress.currentIndex];markReviewBtn.textContent=progress.review[progress.currentIndex]?"Unreview":"Review";renderPalette();};
submitBtn.onclick=()=>showConfirm("Submit Exam?",x=>{if(x)submitExam();});

function updateNavButtons(){
  prevBtn.style.display=progress.currentIndex===0?"none":"inline-block";
  nextBtn.style.display=progress.currentIndex===examData.files.length-1?"none":"inline-block";
  markReviewBtn.textContent=progress.review[progress.currentIndex]?"Unreview":"Review";
}

function renderPalette(){
  paletteContainer.innerHTML="";
  paletteContainer.style.display="grid";                          
  paletteContainer.style.gridTemplateColumns="repeat(20, 1fr)";  
  paletteContainer.style.gap="6px";                              

  progress.answers.forEach((ans,i)=>{
    const b=document.createElement("button"); b.textContent=i+1;
    if(progress.review[i])b.classList.add("reviewed");
    if(i===progress.currentIndex)b.classList.add("current");
    if(ans)b.classList.add("selected");
    b.onclick=()=>{progress.currentIndex=i;renderQuestion();renderPalette();updateNavButtons();};
    paletteContainer.appendChild(b);
  });
}

document.addEventListener("visibilitychange",()=>{
  if(document.hidden && progress) submitExam();
});

function submitExam(){
  clearInterval(timerInterval);
  const subjData={};
  examData.subjectNames.forEach((s,i)=>{
    if(!subjData[s])subjData[s]={correct:0,wrong:0,blank:0,total:0};
    const ans=progress.answers[i];
    if(ans===null)subjData[s].blank++;
    else if(ans===examData.keys[i])subjData[s].correct++;
    else subjData[s].wrong++;
    subjData[s].total++;
  });

  let html=`<h2 style="color:#4B0082;">ðŸŽ‰ðŸŽ‰  Congratulations, ${progress.student.name}</h2>ðŸŽ‰ ðŸŽ‰ 
  <div><b>Section:</b> ${progress.student.sec} | <b>Roll:</b> ${progress.student.roll} | <b>Admission No:</b> ${progress.student.adm}</div>
  <br>
  <div style="overflow-x:auto;display:flex;justify-content:center;width:100%;">
  <table border="1" style="border-collapse:collapse;width:95%;max-width:900px;text-align:center;font-size:18px;height:175%;">   <!-- 30% HEIGHT ADDED -->
  <tr style="background:#E6E6FA;">
    <th>Subject</th><th>Correct</th><th>Wrong</th><th>Blank</th><th>Total</th><th>Percentage</th>
  </tr>`;

  let totalCorrect=0,totalWrong=0,totalBlank=0,totalQs=0;

  for(let s in subjData){
    let v=subjData[s];
    let per=((v.correct/v.total)*100).toFixed(2);
    totalCorrect+=v.correct; totalWrong+=v.wrong; totalBlank+=v.blank; totalQs+=v.total;
    html+=`<tr><td>${s}</td><td>${v.correct}</td><td>${v.wrong}</td><td>${v.blank}</td><td>${v.total}</td><td>${per}%</td></tr>`;
  }

 let totalPer=((totalCorrect/totalQs)*100).toFixed(2);

// Send EACH subject's data to Google Sheet
for (let s in subjData) {
    let v = subjData[s];
    let per = ((v.correct / v.total) * 100).toFixed(2);
    sendToGoogleSheet(s, v.correct, v.wrong, v.blank, v.total, per);
}

  html+=`<tr style="font-weight:bold;background:#D8BFD8;">
    <td>Total</td><td>${totalCorrect}</td><td>${totalWrong}</td><td>${totalBlank}</td><td>${totalQs}</td><td>${totalPer}%</td>
  </tr></table></div><br><button id="logoutBtn" class="glow">Logout</button>`;

  examArea.innerHTML=html;
  logoutBtn.onclick=()=>window.close();
}
</script>

</body>
</html>
